@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@using CundecinosWeb.Enum;
@model CundecinosWeb.ViewModel.vPersonPublication

<style>

    .invalid-feedback {
        color: red;
        font-size: 12px;
    }

    input:invalid {
        border: 1px solid red;
    }

    .imagenes-publicaciones {
        width: 8rem !important;
        height: 8rem !important;
        margin-bottom: 2rem;
    }


    .flex-precio {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        gap: 1rem;
    }

    @@media (min-width: 500px) {

        .flex-precio {
            display: grid;
            align-items: center;
            grid-template-columns: 1fr 2fr 1fr;
        }

            .flex-precio .description {
                flex: 2;
            }
    }

    #archivo {
        margin: 2rem 0;
    }

    }



    .flex-precio input {
        margin-top: .5rem;
    }

    .boton-precio {
        padding: .2rem;
        transition: all .5s ease-in-out;
    }

        .boton-precio:hover {
            transform: translateY(-2px);
        }

</style>

@{
    ViewData["Title"] = "Index";
}



<br />



<!--begin::Post-->
<div class="post d-flex flex-column-fluid" id="kt_post">
    <!--begin::Container-->
    <div id="kt_content_container" class="container">
        <!--begin::Row-->
        <div class="row g-5 g-xl-8">
            <!--begin::Col-->
            <div class="col-12">
                <!--begin::Feeds Widget 1-->
                <div class="card mb-5 mb-xl-8">
                    <!--begin::Body-->
                    <div class="card-body pb-0">
                        <!--begin::Header-->
                        <div class="d-flex align-items-center">
                            <!--begin::User-->
                            <div class="d-flex align-items-center flex-grow-1">
                                <!--begin::Avatar-->
                                @{

                                    var url = $"https://cunpublication.blob.core.windows.net/publication/{@User.FindFirstValue(ClaimTypes.NameIdentifier)}.jpg";
                                }

                                <div class="cursor-pointer symbol symbol-30px symbol-md-40px" data-kt-menu-trigger="click" data-kt-menu-attach="parent" data-kt-menu-placement="bottom-end">
                                    <img src="@url" alt="user" />
                                </div>
                                <!--end::Avatar-->
                                <!--begin::Info-->
                                <div class="d-flex flex-column">
                                    <a href="#" class="text-gray-800 text-hover-primary fs-6 fw-bolder"> @Model.Person.FirstName @Model.Person.LastName</a>
                                    <span class="text-gray-400 fw-bold">@Model.Person.Email</span>
                                </div>
                                <!--end::Info-->
                            </div>
                            <!--end::User-->

                        </div>
                        <!--end::Header-->
                        <!--begin::Editor-->

                        <input type="hidden" asp-i value="@Model.Publication.PersonID" />

                        <br /><br />

                        @using (Html.BeginForm("CreatePublication", "Publication", FormMethod.Post, new { enctype = "multipart/form-data", id = "login" }))
                        {

                            @using (Html.DevExtreme().ValidationGroup())
                            {

                                <div class="row mb-8">
                                    <!--begin::Col-->
                                    <div class="col-xl-2 fv-row">
                                        <div class="fs-6 fw-bold mt-2 mb-3">Titulo</div>
                                    </div>
                                    <!--begin::Col-->
                                    <div class="col-xl-10">
                                        @(Html.DevExtreme().TextBoxFor(x => x.Publication.Qualification))
                                    </div>


                                    <!--end::Col-->
                                </div>

                                <div class="row mb-8">
                                    <!--begin::Col-->
                                    <div class="col-xl-2 fv-row">
                                        <div class="fs-6 fw-bold mt-2 mb-3">Precio estimado</div>
                                    </div>
                                    <!--begin::Col-->
                                    <div class="col-xl-10">
                                        @(Html.DevExtreme().TextBoxFor(x => x.Publication.EstimatedPrice).ReadOnly(false))
                                    </div>
                                    <!--end::Col-->
                                </div>

                                <div class="row mb-8">
                                    <!--begin::Col-->
                                    <div class="col-xl-2 fv-row">
                                        <div class="fs-6 fw-bold mt-2 mb-3">Descripcion del producto</div>
                                    </div>
                                    <!--begin::Col-->
                                    <div class="col-xl-10">
                                        @(Html.DevExtreme().TextBoxFor(x => x.Publication.ProductDescription))
                                    </div>
                                    <!--end::Col-->
                                </div>

                                <div class="row mb-8">
                                    <!--begin::Col-->
                                    <div class="col-xl-2 fv-row">
                                        <div class="fs-6 fw-bold mt-2 mb-3">Descripción</div>
                                    </div>
                                    <!--begin::Col-->
                                    <div class="col-xl-10">
                                        @(Html.DevExtreme().TextBoxFor(x => x.Publication.Content))
                                    </div>
                                    <!--end::Col-->
                                </div>

                                <div class="row mb-8">
                                    <!--begin::Col-->
                                    <div class="col-xl-2 fv-row">
                                        <div class="fs-6 fw-bold mt-2 mb-3">Tipo de Publicación</div>
                                    </div>
                                    <!--begin::Col-->
                                    <div class="col-xl-10">

                                        @(Html.DevExtreme().SelectBoxFor(m => m.Publication.PublicationType)
                                            .DataSource(Html.GetEnumSelectList<CundecinosWeb.Enum.PublicationType>()
                                            .Select(i => new { Value = int.Parse(i.Value), Text = i.Text })
                                            )
                                            .ValueExpr("Value")
                                            .ID("PublicationType")
                                            .DisplayExpr("Text")
                                            .Placeholder("Seleccione...")
                                            )

                                    </div>
                                    <!--end::Col-->
                                </div>

                                @(Html.DevExtreme().TextBoxFor(x => x.Publication.PersonID).Visible(false))

                                @(Html.DevExtreme().FileUploader()
                                    .ID("fileUploader")
                                    .Accept("image/*")
                                    .UploadMode(FileUploadMode.Instantly)
                                    .Name("files")
                                    .Multiple(true)
                                    )

                                <!--end::Editor-->

                                <br /> <div class="separator"></div> <br />

                                <!--begin::Timeline details-->
                                <div class="overflow-auto pb-5">
                                    <!--begin::Notice-->
                                    <div class="notice d-flex bg-light-primary rounded border-primary border border-dashed min-w-lg-600px flex-shrink-0 p-6">

                                        <!--begin::Wrapper-->
                                        <div class="d-flex flex-stack flex-grow-1 flex-wrap flex-md-nowrap">
                                            <!--begin::Content-->
                                            <div class="mb-3 mb-md-0 fw-bold" id="message">
                                                <h4 class="text-gray-800 fw-bolder">Revisa el precio estimado para continuar!</h4>
                                                <div class="fs-6 text-gray-600 pe-7" id="precio"></div>


                                                <br />

                                            </div>

                                            <!--end::Content-->
                                        </div>
                                        <!--end::Wrapper-->
                                    </div>
                                    <!--end::Notice-->
                                </div>
                                <!--end::Timeline details-->


                                <div class="row mb-8">
                                    <!--begin::Col-->
                                    <div class="col-xl-10 fv-row">
                                        <input type="text" class="form-control form-control-solid" id="description" name="description" />
                                    </div>
                                    <!--begin::Col-->
                                    <div class="col-xl-2" style="text-align: center;">
                                        <button class="btn btn-lg btn-primary boton-precio" type="button" onclick="buscarPrecio()"> Buscar precio.</button>
                                    </div>
                                    <!--end::Col-->
                                </div>

                                @(Html.DevExtreme().Button()
                                    .ID("Publication")
                                    .Text("Publicar")
                                    .Type(ButtonType.Success)
                                    // Instructs the Button to validate the TextBoxes and submit the form
                                    .UseSubmitBehavior(true)
                                    .OnClick("ValidationForm")
                                    )
                            }
                        }

                    </div>
                    <!--end::Body-->
                </div>

                <!--end::Feeds Widget 1-->
                @foreach (var item in Model.PublicationUsers)
                {
                    <!--begin::Feeds Widget 2-->
                    <div class="card mb-5 mb-xl-8">
                        <!--begin::Body-->
                        <div class="card-body pb-0">
                            <!--begin::Header-->
                            <div class="d-flex align-items-center mb-5">
                                <!--begin::User-->
                                <div class="d-flex align-items-center flex-grow-1">
                                    <!--begin::Avatar-->
                                    <div class="symbol symbol-45px me-5">
                                        <img class="imagen-avatar" src="@item.Person.AvatarUrl" alt="Avatar Usuario" />
                                    </div>
                                    <!--end::Avatar-->
                                    <!--begin::Info-->
                                    <div class="d-flex flex-column">
                                        <a href="#" class="text-gray-800 text-hover-primary fs-6 fw-bolder">@item.Person.FirstName @item.Person.LastName</a>
                                        <span class="text-gray-400 fw-bold">@item.Person.Email</span>
                                    </div>
                                    <!--end::Info-->
                                </div>
                                <!--end::User-->
                                @if (item.PublicationType == PublicationType.Sale)
                                {

                                    <span class="badge badge-light-success">En Venta</span>

                                }
                                else
                                {


                                    <span class="badge badge-light-warning">En Trueque</span>
                                }


                            </div>
                            <!--end::Header-->
                            <!--begin::Post-->



                            <div class="row g-5 g-xl-8">
                                <div class="col-xl-4">
                                    <!--begin::List Widget 7-->
                                    <div class="card card-xl-stretch mb-xl-8">
                                        <!--begin::Header-->
                                        <div class="card-header align-items-center border-0 mt-4">
                                            <h3 class="card-title align-items-start flex-column">


                                                <span class="fw-bolder text-dark">@item.Qualification</span>
                                                <span class="text-muted mt-1 fw-bold fs-7">@item.Content</span>

                                            </h3>
                                            <div class="card-toolbar">

                                                <!--end::Menu-->
                                            </div>
                                        </div>
                                        <!--end::Header-->
                                    </div>
                                    <!--end::List Widget 7-->
                                </div>
                                <div class="col-xl-8">
                                    <!--begin::List Widget 8-->
                                    <div class="card card-xl-stretch mb-5 mb-xl-8">
                                        <!--begin::Header-->
                                        <div class="card-header align-items-center border-0 mt-4">




                                            @foreach (var imageUrl in item.PublicationAttachment)
                                            {
                                                <!--begin::Symbol-->
                                                <div class="symbol symbol-60px symbol-2by3 me-4">

                                                    <div class="symbol-label" style="background-image: url('@imageUrl.ImageThumbNail'); height: 130px !important; width: 130px !important;"></div>


                                                </div>
                                                <!--end::Symbol-->
                                            }

                                        </div>
                                        <!--end::Header-->
                                    </div>
                                    <!--end::List Widget 8-->
                                </div>
                            </div>





                            <div class="mb-5">
                                <!--begin::Toolbar-->
                                <div class="d-flex align-items-center mb-5">
                                    <a asp-action="Privacy" asp-controller="Home" asp-route-id="@item.PersonID" class="btn btn-sm btn-light btn-color-muted btn-active-light-success px-4 py-2 me-4">
                                        <!--begin::Svg Icon | path: icons/duotone/Communication/Group-chat.svg-->
                                        <span class="svg-icon svg-icon-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                                <path d="M16,15.6315789 L16,12 C16,10.3431458 14.6568542,9 13,9 L6.16183229,9 L6.16183229,5.52631579 C6.16183229,4.13107011 7.29290239,3 8.68814808,3 L20.4776218,3 C21.8728674,3 23.0039375,4.13107011 23.0039375,5.52631579 L23.0039375,13.1052632 L23.0206157,17.786793 C23.0215995,18.0629336 22.7985408,18.2875874 22.5224001,18.2885711 C22.3891754,18.2890457 22.2612702,18.2363324 22.1670655,18.1421277 L19.6565168,15.6315789 L16,15.6315789 Z" fill="#000000" />
                                                <path d="M1.98505595,18 L1.98505595,13 C1.98505595,11.8954305 2.88048645,11 3.98505595,11 L11.9850559,11 C13.0896254,11 13.9850559,11.8954305 13.9850559,13 L13.9850559,18 C13.9850559,19.1045695 13.0896254,20 11.9850559,20 L4.10078614,20 L2.85693427,21.1905292 C2.65744295,21.3814685 2.34093638,21.3745358 2.14999706,21.1750444 C2.06092565,21.0819836 2.01120804,20.958136 2.01120804,20.8293182 L2.01120804,18.32426 C1.99400175,18.2187196 1.98505595,18.1104045 1.98505595,18 Z M6.5,14 C6.22385763,14 6,14.2238576 6,14.5 C6,14.7761424 6.22385763,15 6.5,15 L11.5,15 C11.7761424,15 12,14.7761424 12,14.5 C12,14.2238576 11.7761424,14 11.5,14 L6.5,14 Z M9.5,16 C9.22385763,16 9,16.2238576 9,16.5 C9,16.7761424 9.22385763,17 9.5,17 L11.5,17 C11.7761424,17 12,16.7761424 12,16.5 C12,16.2238576 11.7761424,16 11.5,16 L9.5,16 Z" fill="#000000" opacity="0.3" />
                                            </svg>
                                        </span>
                                        <!--end::Svg Icon-->Contactar
                                </a>
                                    <a asp-controller="PublicationComment" asp-action="PublicationDescription" asp-route-id="@item.PublicationID" class="btn btn-sm btn-light btn-color-muted btn-active-light-success px-4 py-2 me-4">
                                        <!--begin::Svg Icon | path: icons/duotone/Communication/Group-chat.svg-->
                                        <span class="svg-icon svg-icon-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                                <path d="M16,15.6315789 L16,12 C16,10.3431458 14.6568542,9 13,9 L6.16183229,9 L6.16183229,5.52631579 C6.16183229,4.13107011 7.29290239,3 8.68814808,3 L20.4776218,3 C21.8728674,3 23.0039375,4.13107011 23.0039375,5.52631579 L23.0039375,13.1052632 L23.0206157,17.786793 C23.0215995,18.0629336 22.7985408,18.2875874 22.5224001,18.2885711 C22.3891754,18.2890457 22.2612702,18.2363324 22.1670655,18.1421277 L19.6565168,15.6315789 L16,15.6315789 Z" fill="#000000" />
                                                <path d="M1.98505595,18 L1.98505595,13 C1.98505595,11.8954305 2.88048645,11 3.98505595,11 L11.9850559,11 C13.0896254,11 13.9850559,11.8954305 13.9850559,13 L13.9850559,18 C13.9850559,19.1045695 13.0896254,20 11.9850559,20 L4.10078614,20 L2.85693427,21.1905292 C2.65744295,21.3814685 2.34093638,21.3745358 2.14999706,21.1750444 C2.06092565,21.0819836 2.01120804,20.958136 2.01120804,20.8293182 L2.01120804,18.32426 C1.99400175,18.2187196 1.98505595,18.1104045 1.98505595,18 Z M6.5,14 C6.22385763,14 6,14.2238576 6,14.5 C6,14.7761424 6.22385763,15 6.5,15 L11.5,15 C11.7761424,15 12,14.7761424 12,14.5 C12,14.2238576 11.7761424,14 11.5,14 L6.5,14 Z M9.5,16 C9.22385763,16 9,16.2238576 9,16.5 C9,16.7761424 9.22385763,17 9.5,17 L11.5,17 C11.7761424,17 12,16.7761424 12,16.5 C12,16.2238576 11.7761424,16 11.5,16 L9.5,16 Z" fill="#000000" opacity="0.3" />
                                            </svg>

                                        </span>
                                        <!--end::Svg Icon-->@item.PublicationComments.Count
                                    </a>
                                    <a href="#" class="btn btn-sm btn-light btn-color-muted btn-active-light-danger px-4 py-2">
                                        <!--begin::Svg Icon | path: icons/duotone/General/Heart.svg-->
                                        <span class="svg-icon svg-icon-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                                    <polygon points="0 0 24 0 24 24 0 24" />
                                                    <path d="M16.5,4.5 C14.8905,4.5 13.00825,6.32463215 12,7.5 C10.99175,6.32463215 9.1095,4.5 7.5,4.5 C4.651,4.5 3,6.72217984 3,9.55040872 C3,12.6834696 6,16 12,19.5 C18,16 21,12.75 21,9.75 C21,6.92177112 19.349,4.5 16.5,4.5 Z" fill="#000000" fill-rule="nonzero" />
                                                </g>
                                            </svg>
                                        </span>
                                        <!--end::Svg Icon-->15
                                </a>
                                </div>
                                <!--end::Toolbar-->
                            </div>
                            <!--end::Post-->
                            <!--begin::Separator-->
                            <div class="separator mb-4"></div>
                            <!--end::Separator-->
                            <!--begin::Reply input-->
                            <form class="position-relative mb-6">
                                <textarea class="form-control border-0 p-0 pe-10 resize-none min-h-25px" data-kt-autosize="true" rows="1" placeholder="Reply.."></textarea>
                                <div class="position-absolute top-0 end-0 me-n5">
                                    <span class="btn btn-icon btn-sm btn-active-color-primary pe-0 me-2">
                                        <!--begin::Svg Icon | path: icons/duotone/General/Clip.svg-->
                                        <span class="svg-icon svg-icon-3 mb-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                                    <rect x="0" y="0" width="24" height="24" />
                                                    <path d="M14,16 L12,16 L12,12.5 C12,11.6715729 11.3284271,11 10.5,11 C9.67157288,11 9,11.6715729 9,12.5 L9,17.5 C9,19.4329966 10.5670034,21 12.5,21 C14.4329966,21 16,19.4329966 16,17.5 L16,7.5 C16,5.56700338 14.4329966,4 12.5,4 L12,4 C10.3431458,4 9,5.34314575 9,7 L7,7 C7,4.23857625 9.23857625,2 12,2 L12.5,2 C15.5375661,2 18,4.46243388 18,7.5 L18,17.5 C18,20.5375661 15.5375661,23 12.5,23 C9.46243388,23 7,20.5375661 7,17.5 L7,12.5 C7,10.5670034 8.56700338,9 10.5,9 C12.4329966,9 14,10.5670034 14,12.5 L14,16 Z" fill="#000000" fill-rule="nonzero" transform="translate(12.500000, 12.500000) rotate(-315.000000) translate(-12.500000, -12.500000)" />
                                                </g>
                                            </svg>
                                        </span>
                                        <!--end::Svg Icon-->
                                    </span>
                                    <span class="btn btn-icon btn-sm btn-active-color-primary ps-0">
                                        <!--begin::Svg Icon | path: icons/duotone/Map/Marker1.svg-->
                                        <span class="svg-icon svg-icon-2 mb-3">
                                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                                    <rect x="0" y="0" width="24" height="24" />
                                                    <path d="M5,10.5 C5,6 8,3 12.5,3 C17,3 20,6.75 20,10.5 C20,12.8325623 17.8236613,16.03566 13.470984,20.1092932 C12.9154018,20.6292577 12.0585054,20.6508331 11.4774555,20.1594925 C7.15915182,16.5078313 5,13.2880005 5,10.5 Z M12.5,12 C13.8807119,12 15,10.8807119 15,9.5 C15,8.11928813 13.8807119,7 12.5,7 C11.1192881,7 10,8.11928813 10,9.5 C10,10.8807119 11.1192881,12 12.5,12 Z" fill="#000000" fill-rule="nonzero" />
                                                </g>
                                            </svg>
                                        </span>
                                        <!--end::Svg Icon-->
                                    </span>
                                </div>
                            </form>
                            <!--edit::Reply input-->
                        </div>
                        <!--end::Body-->
                    </div>
                    <!--end::Feeds Widget 2-->
                }

                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                <script>

                    function ValidationForm() {
                        var validator = $('#login').dxValidator('instance');
                        validator.validate();

                    }

                    function buscarPrecio() {
                        var formData = {
                            description: $("#description").val()
                        };

                        $.ajax({
                            type: "POST",
                            url: "/WebScraper/ScrapePrice",
                            data: formData,
                            success: function (data) {
                                $("#precio").text(data);
                                $('#Publication_EstimatedPrice').val(data.substring(data.indexOf(":") + 1));

                            }
                        });
                    }
                </script>
